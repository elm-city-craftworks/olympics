#!/usr/bin/env ruby
# coding: UTF-8

require "csv"

MAPPING = { "Great Britain"          => "United Kingdom",
            "Russia"                 => "Russian Federation",
            "Serbia and Montenegro"  => "Serbia/Montenegro/Kosovo",
            "Chinese Taipei"         => "Taiwan",
            "DR Congo"               => "Zaire (Congo Kinshasa)",
            "Congo"                  => "Congo 'Brazzaville'",
            "Bosnia and Herzegovina" => "Bosnia",
            "Haiti"                  => "Haïti" }

#MAPPING = {  "United Kingdom"                         => "Great Britain",
           # "Haïti"                                  => "Haiti",
           # "Bosnia"                                 => "Bosnia and Herzegovina",
#            "Russian Federation"                     => "Russia" }
           # "Serbia/Montenegro/Kosovo"               => "Serbia and Montenegro",
           # "Taiwan"                                 => "Chinese Taipei",
           # "Indonesia (including Timor until 1999)" => "Indonesia" }.invert

combined_data = {}

CSV.foreach("data/#{ARGV[0]}_participants.csv") do |noc, participants|
  combined_data[noc] = { :participants => participants }
end


CSV.foreach("data/medal_table_#{ARGV[0]}.csv") do |noc, gold, silver, bronze, total| 
  combined_data[noc][:gold]   = gold
  combined_data[noc][:silver] = silver
  combined_data[noc][:bronze] = bronze
  combined_data[noc][:total]  = total
end

gdp_data = {}

CSV.foreach("data/gdp.csv", :headers => true) do |row|
  gdp_data[row[0].strip] = row[ARGV[0]]
end

combined_data.keys.each do |noc|
  if gdp_data.key?(noc)
    combined_data[noc][:gdp] = gdp_data[noc]
  elsif gdp_data.key?(MAPPING[noc])
    combined_data[noc][:gdp] = gdp_data[MAPPING[noc]]
  else
    p "GDP: #{noc}"
  end
end

population_data = {}

CSV.foreach("data/population.csv", :headers => true) do |row|
  population_data[row[0].strip] = row[ARGV[0]]
end

combined_data.keys.each do |noc|
  if population_data.key?(noc)
    combined_data[noc][:population] = population_data[noc]
  elsif population_data.key?(MAPPING[noc])
    combined_data[noc][:population] = population_data[MAPPING[noc]]
  else
    p "POP: #{noc}"
  end
end

capita_data = {}

CSV.foreach("data/gdp-capita.csv", :headers => true) do |row|
  capita_data[row[0].strip] = row[ARGV[0]]
end

combined_data.keys.each do |noc|
  if capita_data.key?(noc)
    combined_data[noc][:capita] = capita_data[noc]
  elsif population_data.key?(MAPPING[noc])
    combined_data[noc][:capita] = capita_data[MAPPING[noc]]
  else
    p "CAPITA: #{noc}"
  end
end





CSV.open("data/#{ARGV[0]}_combined.csv", "w") do |csv|
  combined_data.each do |noc, data|
    info = data.values_at(:participants, :gold, :silver, :bronze, :total)
               .map { |e| e || 0 }
    csv << [noc] + info + data.values_at(:gdp, :population, :capita)
  end
end
